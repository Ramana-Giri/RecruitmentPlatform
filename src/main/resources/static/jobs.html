<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Jobs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4 text-primary">Open Job Listings</h1>

    <div class="mb-4">
        <input type="text" id="searchKeyword" class="form-control" placeholder="Search by title, skills, or description..." onkeyup="fetchJobs()">
    </div>

    <div id="jobListings" class="row">
        <p>Loading jobs...</p>
    </div>
</div>
<script src="js/utils.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', fetchJobs);

    function getUserId() {
        // Note: In a real app, you'd verify a token, not just rely on local storage for ID
        return localStorage.getItem('userId');
    }

    async function fetchJobs() {
        const listingsDiv = document.getElementById('jobListings');
        const keyword = document.getElementById('searchKeyword').value;

        listingsDiv.innerHTML = '<div class="col-12"><p class="text-info">Loading jobs...</p></div>';

        let endpoint = '/api/jobs/search';
        if (keyword) {
            endpoint += `?keyword=${encodeURIComponent(keyword)}`;
        }

        try {
            const jobs = await fetchApi(endpoint, 'GET');
            listingsDiv.innerHTML = '';

            if (jobs.length === 0) {
                listingsDiv.innerHTML = '<div class="col-12"><p class="text-muted">No matching job listings found.</p></div>';
                return;
            }

            jobs.forEach(job => {
                // ... (Job card HTML remains the same)
                const jobCard = document.createElement('div');
                jobCard.className = 'col-lg-4 col-md-6 mb-4';
                jobCard.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title text-success">${job.title}</h5>
                            <h6 class="card-subtitle mb-2 text-muted">${job.location}</h6>
                            <p class="card-text"><strong>Skills:</strong> ${job.requiredSkills}</p>
                            <p class="card-text text-truncate">${job.description}</p>
                            <button class="btn btn-primary w-100" onclick="applyForJob(${job.id}, '${job.title}')">Apply Now</button>
                        </div>
                    </div>
                `;
                listingsDiv.appendChild(jobCard);
            });
        } catch (error) {
            listingsDiv.innerHTML = `<div class="col-12"><p class="text-danger">Error loading jobs: ${error.message}</p></div>`;
            console.error('Error fetching jobs:', error);
        }
    }

    function applyForJob(jobId, jobTitle) {
        const userId = getUserId();
        if (!userId || localStorage.getItem('userRole') !== 'CANDIDATE') {
            alert("Please log in as a Jobseeker to apply for a job.");
            window.location.href = 'index.html';
            return;
        }
        window.location.href = `upload_resume.html?jobId=${jobId}&candidateId=${userId}&jobTitle=${encodeURIComponent(jobTitle)}`;
    }
</script>
</body>
</html>